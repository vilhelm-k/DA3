---
title: "Hypothesis Testing and Mediation Analysis"
author: "Your Name"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Required Libraries and Data Import

```{r}
library(ggplot2)
library(rio)
library(mediation)

df <- rio::import("BE603_gr_10.csv")
```

## Hypothesis 1: Community Effect (Mediation Analysis)

### Models and Bootstrap

```{r, results='asis'}
model_T <- lm(collected_funds ~ updates_count, data = df)
model_M <- lm(comments_count ~ updates_count, data = df)
model_Y <- lm(collected_funds ~ updates_count + comments_count + pitch_size + campaign_quality + images, data = df)

model_bootstrap <- mediation::mediate(
    model.m = model_M,
    model.y = model_Y,
    treat = "updates_count",
    mediator = "comments_count",
    boot = TRUE,
    sims = 500
)
stargazer::stargazer(model_T, model_M, model_Y, type = "text")
```

### Visualization

```{r}
plot(model_bootstrap)
```
```{r}
summary(model_bootstrap)
```


```{r}
ggplot(df) +
    aes(y = comments_count, x = updates_count) +
    geom_hline(yintercept = 1, linetype = "dashed", alpha = 0.5) +
    geom_point(alpha = 0.5) +
    geom_smooth(method = "lm", formula = "y ~ x", se = TRUE) +
    labs(
        y = "Comments Count",
        x = "Updates Count"
    ) +
    theme_classic()
```

```{r}
ggplot(df) +
    aes(y = collected_funds, x = updates_count) +
    geom_hline(yintercept = 1, linetype = "dashed", alpha = 0.5) +
    geom_point(alpha = 0.5) +
    geom_smooth(method = "lm", formula = "y ~ x", se = TRUE) +
    labs(
        y = "Collected funds",
        x = "Updates Count"
    ) +
    theme_classic()
```

# Hypothesis 2: Social and Negative Emotion Interaction

### Model

```{r, results='asis'}
model_H2 <- lm(collected_funds ~ social * negemo, data = df)
summary(model_H2)
```

### Visualization

```{r}
df$social_factor <- as.factor(df$social)

ggplot(df) +
    aes(y = collected_funds, x = negemo, color = social_factor) +
    geom_hline(yintercept = 1, linetype = "dashed", alpha = 0.5) +
    geom_point(alpha = 0.5) +
    geom_smooth(method = "lm", formula = "y ~ x", se = TRUE) +
    labs(
        y = "Collected funds",
        x = "Negative emotion",
        color = "Social (0/1)"
    ) +
    scale_color_discrete(labels = c("No Social", "Social")) +
    theme_classic()
```

## Hypothesis 3: Early Success

### Model and Visualization

```{r, results='asis'}
model_H3 <- lm(collected_funds ~ goal, data = df)
stargazer::stargazer(model_H3, type = "text")
```


```{r, results='asis'}
ggplot(df) +
    aes(y = collected_funds, x = goal) +
    geom_hline(yintercept = 1, linetype = "dashed", alpha = 0.5) +
    geom_point(alpha = 0.5) +
    geom_smooth(method = "lm", formula = "y ~ x", se = TRUE) +
    labs(
        y = "Collected funds",
        x = "Goal",
        title = "Correlation between goal and collected funds"
    ) +
    theme_classic()
```

```{r, results='asis'}
summary(model_H3)
```
```{r}
library(corrplot)
cor_matrix <- cor(df[sapply(df, is.numeric)], use = "complete.obs")
corrplot(cor_matrix,
    method = "color", type = "upper",
    tl.col = "black", tl.srt = 45,
)
```

```{r, fig.width=13, fig.height=12}
dir.create("figures", showWarnings = FALSE)

png("figures/assumption_plots.png",
    width = 13,
    height = 12,
    units = "in",
    res = 1200
)
par(mfrow = c(5, 3), mar = c(2, 2, 2, 1))

plot_residuals <- function(model, title) {
    hist(residuals(model),
        breaks = 100,
        probability = TRUE,
        main = title,
        xlab = "Residuals",
        col = "lightgray",
        border = "white"
    )
    lines(density(residuals(model)), col = "blue", lwd = 2)
}

plot_abs_residuals <- function(model, title, x) {
    plot(x, abs(model$residuals),
        main = title,
        ylab = "Absolute Residuals",
        xlab = "X",
        type = "n",
        col = "lightgray",
        border = "white"
    )
    abline(h = 0, col = "black")
    points(x, abs(model$residuals), pch = 4, col = "black")
}

plot_cooks <- function(model, title) {
    plot(cooks.distance(model),
        type = "h",
        main = title,
        xlab = "",
        ylab = "Cook's Distance"
    )
    abline(h = 4 / nrow(df), col = "red", lty = 2)
}

# Row 1: H1
plot_residuals(model_H3, "H1: Residuals")
plot_abs_residuals(model_H3, "H1: Abs Residuals", df$goal)
plot_cooks(model_H3, "H1: Cook's Distance")


# Row 2: H2 (T)
plot_residuals(model_T, "H2-T: Residuals")
plot_abs_residuals(model_T, "H2-T: Abs Residuals", df$updates_count)
plot_cooks(model_T, "H2-T: Cook's Distance")

# Row 3: H2 (M)
plot_residuals(model_M, "H2-M: Residuals")
plot_abs_residuals(model_M, "H2-M: Abs Residuals", df$updates_count)
plot_cooks(model_M, "H2-M: Cook's Distance")

# Row 4: H2 (Y)
plot_residuals(model_Y, "H2-Y: Residuals")
plot_abs_residuals(model_Y, "H2-Y: Abs Residuals", df$updates_count)
plot_cooks(model_Y, "H2-Y: Cook's Distance")

# Row 5: H3
plot_residuals(model_H2, "H3: Residuals")
plot_abs_residuals(model_H2, "H3: Abs Residuals", df$negemo)
plot_cooks(model_H2, "H3: Cook's Distance")

par(mfrow = c(1, 1))
dev.off()
```

```{r}
regclass::VIF(model_Y)
regclass::VIF(model_H2)
```